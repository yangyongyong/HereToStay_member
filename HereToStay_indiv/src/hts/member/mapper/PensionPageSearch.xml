<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pensionPageSearch">
<select id="getList" parameterType="hashMap" resultType="pension">
<![CDATA[
SELECT
    pen_id,pen_name
FROM
    (SELECT
        rownum as Rnum,pen_id,pen_name
    FROM
        (SELECT
            *
        FROM
            pension
        ORDER BY pen_id DESC)
    WHERE rownum <= #{last})
 WHERE Rnum >= #{first}
 ]]>
</select>
<sql id='search'>
<![CDATA[
from
 (select p.*,ot.*,rv.cnt as rev_cnt,floor(NVL(rv.avgStar,0)) as avg_star,rownum as rnum
 from pension p,(
 select p.pen_id as pen,min(r.rom_Cost) as min_Cost
 from pension p ,room r  ]]>
<where> p.pen_id=r.pen_id<if test="penName!=null"> and (p.pen_name like '%'||#{penName}||'%' or p.pen_addr2 like '%'||#{penName}||'%')</if>
<if test="penOpt!=null"><foreach item="item" index="index" collection="penOpt"> AND p.pen_opt LIKE '%' || #{item} || '%'
</foreach></if><if test="persons!=null"> and
 r.rom_people >=#{persons}</if><if test="priceFrom!=null and priceTo!=null">and r.rom_cost between #{priceFrom} and #{priceTo} </if>
<if test="roomOpt!=null"><foreach item="item" index="index" collection="roomOpt"> AND r.rom_opt LIKE '%' || #{item} || '%'</foreach></if>
  and r.rom_id not in (select rom_id from reservation <where><if test ="checkIn!=null">TO_DATE(#{checkIn},'YY/MM/DD')  between res_indate and res_outdate</if>
 <if test ="checkOut!=null">or TO_DATE(#{checkOut},'YY/MM/DD')  between res_indate and res_outdate</if></where>)
 group by p.pen_id
 </where>
 <![CDATA[
 )ot left outer join(select p.pen_id as p,count(rv.rev_id) as cnt,avg(rv.rev_star) as avgStar from reservation re,pension p,room r,review rv 
where p.pen_id=r.pen_id and r.rom_id=re.rom_id and re.res_id =rv.res_id group by p.pen_id)rv
on ot.pen=rv.p
 where p.pen_id=ot.pen )f
 ]]>
</sql>
<select id="getListOpt" parameterType="hashMap" resultType="pension">
<![CDATA[
select f.*]]>
<include refid='search'></include>
 <![CDATA[
where f.rnum between 0 and 100
 ]]>
</select>
<select id="getTotal" parameterType="hashMap" resultType="integer">
<![CDATA[
SELECT count(f.pen) as cnt 
from
 (select p.*,ot.*,rv.cnt as rev_cnt,floor(NVL(rv.avgStar,0)) as avg_star,rownum as rnum
 from pension p,(
 select p.pen_id as pen,min(r.rom_Cost) as min_Cost
 from pension p ,room r  ]]>
<where> p.pen_id=r.pen_id<if test="penName!=null"> and (p.pen_name like '%'||#{penName}||'%' or p.pen_addr2 like '%'||#{penName}||'%')</if>
<if test="penOpt!=null"><foreach item="item" index="index" collection="penOpt"> AND p.pen_opt LIKE '%' || #{item} || '%'
</foreach></if>
<if test="persons!=null"> and r.rom_people >=#{persons}</if><if test="priceFrom!=null and priceTo!=null">and r.rom_cost between #{priceFrom} and #{priceTo} </if>
<if test="roomOpt!=null"><foreach item="item" index="index" collection="roomOpt"> AND r.rom_opt LIKE '%' || #{item} || '%'</foreach></if>
 and r.rom_id not in (select rom_id from reservation <where><if test ="checkIn!=null">TO_DATE(#{checkIn},'YY/MM/DD') between res_indate and res_outdate</if>
 <if test ="checkOut!=null">or TO_DATE(#{checkOut},'YY/MM/DD') between res_indate and res_outdate</if></where>)
 group by p.pen_id
 </where>
 <![CDATA[
 )ot left outer join(select p.pen_id as p,count(rv.rev_id) as cnt,avg(rv.rev_star) as avgStar from reservation re,pension p,room r,review rv 
where p.pen_id=r.pen_id and r.rom_id=re.rom_id and re.res_id =rv.res_id group by p.pen_id)rv
on ot.pen=rv.p
 where p.pen_id=ot.pen )f
 ]]>
</select>
</mapper>